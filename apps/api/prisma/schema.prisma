// Prisma schema for initial OKR/Initiative/Worklog and Org

generator client {
  provider = "prisma-client-js"
}

model UserGoal {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  title       String
  description String?
  kind        GoalKind @default(QUALITATIVE)
  metric      String?
  target      Float?
  unit        String?
  startAt     DateTime?
  endAt       DateTime?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  initiatives Initiative[]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Role {
  CEO
  EXEC
  MANAGER
  INDIVIDUAL
}

enum ObjectiveStatus {
  DRAFT
  ACTIVE
  LOCKED
  ARCHIVED
}

enum InitiativeState {
  PLANNED
  ACTIVE
  BLOCKED
  DONE
  CANCELLED
}

enum InitiativeType {
  PROJECT
  OPERATIONAL
}

enum Cadence {
  DAILY
  WEEKLY
  MONTHLY
  QUARTERLY
  HALF_YEARLY
  YEARLY
}

enum KeyResultType {
  PROJECT
  OPERATIONAL
}

enum ThresholdDirection {
  AT_LEAST
  AT_MOST
}

enum Pillar {
  Q
  C
  D
  DEV
  P
}

model OrgUnit {
  id        String    @id @default(cuid())
  name      String
  type      String
  parentId  String?
  parent    OrgUnit?  @relation("OrgHierarchy", fields: [parentId], references: [id])
  children  OrgUnit[] @relation("OrgHierarchy")
  managerId String?
  manager   User?     @relation("OrgManager", fields: [managerId], references: [id])
  users     User[]
  objectives Objective[]
  processTemplates ProcessTemplate[]
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String
  role       Role
  orgUnitId  String?
  orgUnit    OrgUnit? @relation(fields: [orgUnitId], references: [id])
  objectives Objective[] @relation("ObjectiveOwner")
  initiatives Initiative[] @relation("InitiativeOwner")
  managedUnits OrgUnit[] @relation("OrgManager")
  keyResultsOwned KeyResult[] @relation("KeyResultOwner")
  worklogsCreated Worklog[] @relation("WorklogCreator")
  approvalRequestsRequested ApprovalRequest[] @relation("ApprovalRequestedBy")
  approvalRequestsToApprove ApprovalRequest[] @relation("ApprovalApprover")
  approvalStepsToApprove ApprovalStep[] @relation("ApprovalStepApprover")
  shares Share[]
  feedbacksAuthored Feedback[]
  helpTicketsRequested HelpTicket[] @relation("HelpRequester")
  helpTicketsAssigned HelpTicket[] @relation("HelpAssignee")
  delegationsMade Delegation[] @relation("Delegator")
  delegationsReceived Delegation[] @relation("Delegatee")
  notifications Notification[]
  passwordHash String?
  checklistTicks ChecklistTick[]
  userGoals UserGoal[]
  progressEntries ProgressEntry[]
  keyResultAssignments KeyResultAssignment[]
  carDispatchRequestsRequested CarDispatchRequest[] @relation("CarDispatchRequester")
  carDispatchRequestsToApprove CarDispatchRequest[] @relation("CarDispatchApprover")
  attendanceRequests AttendanceRequest[]
  processTemplatesOwned ProcessTemplate[]
  processInstancesStarted ProcessInstance[] @relation("ProcessInstanceStartedBy")
}

model Objective {
  id          String    @id @default(cuid())
  title       String
  description String?
  orgUnitId   String
  orgUnit     OrgUnit   @relation(fields: [orgUnitId], references: [id])
  ownerId     String
  owner       User      @relation("ObjectiveOwner", fields: [ownerId], references: [id])
  parentId    String?
  parent      Objective? @relation("ObjectiveTree", fields: [parentId], references: [id])
  children    Objective[] @relation("ObjectiveTree")
  status      ObjectiveStatus @default(DRAFT)
  periodStart DateTime
  periodEnd   DateTime
  alignsToKrId String?
  alignsToKr   KeyResult? @relation("ObjectiveAlignedToKR", fields: [alignsToKrId], references: [id])
  keyResults  KeyResult[]
  pillar      Pillar?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
}

model KeyResult {
  id           String    @id @default(cuid())
  objectiveId  String
  objective    Objective @relation(fields: [objectiveId], references: [id])
  title        String
  metric       String
  target       Float
  unit         String
  weight       Float     @default(1)
  ownerId      String
  owner        User      @relation("KeyResultOwner", fields: [ownerId], references: [id])
  initiatives  Initiative[]
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt
  type         KeyResultType @default(PROJECT)
  alignedObjectives Objective[] @relation("ObjectiveAlignedToKR")
  pillar       Pillar?
  baseline     Float?
  year25Target Float?
  cadence      Cadence?
  progressEntries ProgressEntry[]
  direction    ThresholdDirection?
  assignments  KeyResultAssignment[]
  analysis25   String?
}

model KeyResultAssignment {
  id          String   @id @default(cuid())
  keyResultId String
  keyResult   KeyResult @relation(fields: [keyResultId], references: [id])
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  role        String?
  createdAt   DateTime @default(now())
}

model Initiative {
  id            String   @id @default(cuid())
  keyResultId   String
  keyResult     KeyResult @relation(fields: [keyResultId], references: [id])
  title         String
  description   String?
  state         InitiativeState @default(PLANNED)
  type          InitiativeType  @default(PROJECT)
  ownerId       String
  owner         User     @relation("InitiativeOwner", fields: [ownerId], references: [id])
  priority      Int      @default(3)
  slaMinutes    Int?
  dueAt         DateTime?
  startAt       DateTime?
  endAt         DateTime?
  cadence       Cadence?
  cadenceAnchor String?
  worklogs      Worklog[]
  checklistItems ChecklistItem[]
  userGoalId    String?
  userGoal      UserGoal? @relation(fields: [userGoalId], references: [id])
  parentId      String?
  parent        Initiative? @relation("InitiativeTree", fields: [parentId], references: [id])
  children      Initiative[] @relation("InitiativeTree")
  delegationsAsChild Delegation[] @relation("DelegationChildInitiative")
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  progressEntries ProgressEntry[]
  processInstances ProcessInstance[]
  processTaskInstances ProcessTaskInstance[]
}

model Worklog {
  id                 String   @id @default(cuid())
  initiativeId       String
  initiative         Initiative @relation(fields: [initiativeId], references: [id])
  date               DateTime  @default(now())
  progressPct        Int       @default(0)
  timeSpentMinutes   Int       @default(0)
  blockerCode        String?
  note               String?
  createdById        String
  createdBy          User      @relation("WorklogCreator", fields: [createdById], references: [id])
  attachments        Json?
  createdAt          DateTime  @default(now())
  urgent             Boolean   @default(false)
  progressEntries    ProgressEntry[]
  visibility         WorklogVisibility @default(ALL)
}

model Event {
  id          String   @id @default(cuid())
  subjectType String
  subjectId   String
  activity    String
  ts          DateTime @default(now())
  userId      String?
  assetId     String?
  attrs       Json?
  idx         Int      @default(0)
}

model Asset {
  id     String @id @default(cuid())
  name   String
  type   String
  code   String  @unique
}

enum ApprovalStatus {
  PENDING
  APPROVED
  REJECTED
  EXPIRED
}

enum ShareScope {
  READ
  COMMENT
}

enum FeedbackType {
  GENERAL
  RUBRIC
}

enum HelpStatus {
  OPEN
  ACCEPTED
  IN_PROGRESS
  BLOCKED
  DONE
  CANCELLED
}

enum DelegationStatus {
  PENDING
  ACCEPTED
  REJECTED
  ACTIVE
  BLOCKED
  DONE
}

enum WorklogVisibility {
  ALL
  MANAGER_PLUS
  EXEC_PLUS
  CEO_ONLY
}

enum GoalKind {
  QUALITATIVE
  QUANTITATIVE
}

enum DispatchStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

enum AttendanceType {
  OT
  VACATION
  EARLY_LEAVE
  FLEXIBLE
  HOLIDAY_WORK
  HOLIDAY_REST
}

enum ProcessType {
  RECURRING
  PROJECT
}

enum ProcessVisibility {
  PUBLIC
  ORG_UNIT
  PRIVATE
}

enum TaskType {
  COOPERATION
  WORKLOG
  APPROVAL
  TASK
}

enum AssigneeType {
  USER
  ORG_UNIT
  ROLE
}

enum ApprovalRouteType {
  ORG_CHART
  ROLE_BASED
  CUSTOM_USERS
}

model ApprovalRequest {
  id             String          @id @default(cuid())
  subjectType    String
  subjectId      String
  status         ApprovalStatus  @default(PENDING)
  requestedById  String
  requestedBy    User            @relation("ApprovalRequestedBy", fields: [requestedById], references: [id])
  approverId     String
  approver       User            @relation("ApprovalApprover", fields: [approverId], references: [id])
  dueAt          DateTime?
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  steps          ApprovalStep[]
}

model ApprovalStep {
  id         String          @id @default(cuid())
  requestId  String
  request    ApprovalRequest @relation(fields: [requestId], references: [id])
  stepNo     Int
  approverId String
  approver   User            @relation("ApprovalStepApprover", fields: [approverId], references: [id])
  status     ApprovalStatus  @default(PENDING)
  comment    String?
  actedAt    DateTime?
}

model Share {
  id          String     @id @default(cuid())
  subjectType String
  subjectId   String
  watcherId   String
  watcher     User       @relation(fields: [watcherId], references: [id])
  scope       ShareScope @default(READ)
  createdAt   DateTime   @default(now())
}

model Feedback {
  id          String        @id @default(cuid())
  subjectType String
  subjectId   String
  authorId    String
  author      User          @relation(fields: [authorId], references: [id])
  type        FeedbackType  @default(GENERAL)
  content     String
  rating      Int?
  actionRequired Boolean    @default(false)
  createdAt   DateTime      @default(now())
}

model HelpTicket {
  id           String      @id @default(cuid())
  category     String
  queue        String?
  requesterId  String
  requester    User        @relation("HelpRequester", fields: [requesterId], references: [id])
  assigneeId   String?
  assignee     User?       @relation("HelpAssignee", fields: [assigneeId], references: [id])
  status       HelpStatus  @default(OPEN)
  dueAt        DateTime?
  slaMinutes   Int?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  resolvedAt   DateTime?
}

model Delegation {
  id                 String            @id @default(cuid())
  parentType         String
  parentId           String
  childInitiativeId  String
  childInitiative    Initiative        @relation("DelegationChildInitiative", fields: [childInitiativeId], references: [id])
  delegatorId        String
  delegator          User              @relation("Delegator", fields: [delegatorId], references: [id])
  delegateeId        String
  delegatee          User              @relation("Delegatee", fields: [delegateeId], references: [id])
  status             DelegationStatus  @default(PENDING)
  dueAt              DateTime?
  createdAt          DateTime          @default(now())
  updatedAt          DateTime          @updatedAt
  acceptedAt         DateTime?
  rejectedAt         DateTime?
}

model Notification {
  id          String   @id @default(cuid())
  userId      String
  user        User     @relation(fields: [userId], references: [id])
  type        String
  subjectType String
  subjectId   String
  payload     Json?
  readAt      DateTime?
  createdAt   DateTime @default(now())
}

model Upload {
  id           String   @id @default(cuid())
  filename     String   @unique
  originalName String?
  contentType  String?
  size         Int
  data         Bytes
  createdAt    DateTime @default(now())
}

model ChecklistItem {
  id            String   @id @default(cuid())
  initiativeId  String
  initiative    Initiative @relation(fields: [initiativeId], references: [id])
  title         String
  order         Int      @default(0)
  active        Boolean  @default(true)
  createdAt     DateTime @default(now())
  ticks         ChecklistTick[]
}

model ChecklistTick {
  id              String   @id @default(cuid())
  checklistItemId String
  checklistItem   ChecklistItem @relation(fields: [checklistItemId], references: [id])
  periodStart     DateTime
  periodEnd       DateTime
  checkedAt       DateTime @default(now())
  actorId         String
  actor           User     @relation(fields: [actorId], references: [id])
}

model ProgressEntry {
  id            String    @id @default(cuid())
  worklogId     String?
  worklog       Worklog?  @relation(fields: [worklogId], references: [id])
  actorId       String
  actor         User      @relation(fields: [actorId], references: [id])
  keyResultId   String?
  keyResult     KeyResult? @relation(fields: [keyResultId], references: [id])
  initiativeId  String?
  initiative    Initiative? @relation(fields: [initiativeId], references: [id])
  periodStart   DateTime
  periodEnd     DateTime
  krValue       Float?
  initiativeDone Boolean?
  note          String?
  createdAt     DateTime @default(now())
}

model Car {
  id        String   @id @default(cuid())
  name      String
  type      String?
  plateNo   String?
  active    Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  dispatchRequests CarDispatchRequest[]
}

model CarDispatchRequest {
  id          String          @id @default(cuid())
  carId       String
  car         Car             @relation(fields: [carId], references: [id])
  requesterId String
  requester   User            @relation("CarDispatchRequester", fields: [requesterId], references: [id])
  approverId  String
  approver    User            @relation("CarDispatchApprover", fields: [approverId], references: [id])
  coRiders    String?
  startAt     DateTime
  endAt       DateTime
  destination String
  purpose     String
  status      DispatchStatus  @default(PENDING)
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt
}

model AttendanceRequest {
  id        String         @id @default(cuid())
  userId    String
  user      User           @relation(fields: [userId], references: [id])
  type      AttendanceType
  date      DateTime
  startAt   DateTime?
  endAt     DateTime?
  reason    String?
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt
}

model ProcessTemplate {
  id                         String             @id @default(cuid())
  title                      String
  description                String?
  type                       ProcessType        @default(PROJECT)
  ownerId                    String
  owner                      User               @relation(fields: [ownerId], references: [id])
  visibility                 ProcessVisibility  @default(PUBLIC)
  orgUnitId                  String?
  orgUnit                    OrgUnit?           @relation(fields: [orgUnitId], references: [id])
  recurrenceType             String?
  recurrenceDetail           String?
  bpmnJson                   Json?
  resultInputRequired        Boolean            @default(false)
  expectedDurationDays       Int?
  expectedCompletionCriteria String?
  allowExtendDeadline        Boolean            @default(true)
  status                     String             @default("ACTIVE")
  createdAt                  DateTime           @default(now())
  updatedAt                  DateTime           @updatedAt
  tasks                      ProcessTaskTemplate[]
  instances                  ProcessInstance[]
}

model ProcessTaskTemplate {
  id                     String            @id @default(cuid())
  processTemplateId      String
  processTemplate        ProcessTemplate   @relation(fields: [processTemplateId], references: [id])
  name                   String
  description            String?
  assigneeHint           String?
  taskType               TaskType          @default(TASK)
  orderHint              Int               @default(0)
  stageLabel             String?
  predecessorIds         String?           // comma-separated template IDs
  predecessorMode        String?           // 'ALL'(default) or 'ANY' (for XOR joins)
  xorGroupKey            String?
  assigneeType           AssigneeType?
  assigneeUserId         String?
  assigneeOrgUnitId      String?
  assigneeRoleCode       String?
  cooperationTargetType  AssigneeType?
  cooperationTargetUserId String?
  cooperationTargetOrgUnitId String?
  cooperationTargetRoleCode String?
  expectedOutput         String?
  worklogTemplateHint    String?
  linkToKpiType          String?
  approvalRouteType      ApprovalRouteType?
  approvalRoleCodes      String?           // comma-separated role codes
  approvalUserIds        String?           // comma-separated user IDs
  isFinalApproval        Boolean           @default(false)
  deadlineOffsetDays     Int?
  slaHours               Int?
  allowDelayReasonRequired Boolean        @default(false)
  taskInstances          ProcessTaskInstance[]
}

model ProcessInstance {
  id              String            @id @default(cuid())
  templateId      String
  template        ProcessTemplate   @relation(fields: [templateId], references: [id])
  title           String
  startedById     String
  startedBy       User             @relation("ProcessInstanceStartedBy", fields: [startedById], references: [id])
  status          String           @default("ACTIVE")
  startAt         DateTime         @default(now())
  endAt           DateTime?
  expectedEndAt   DateTime?
  itemCode        String?          // 품번 등 기준 정보 코드
  moldCode        String?          // 금형 번호
  carModelCode    String?          // 차종 코드
  initiativeId    String?
  initiative      Initiative?      @relation(fields: [initiativeId], references: [id])
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  tasks           ProcessTaskInstance[]
}

model ProcessTaskInstance {
  id                String              @id @default(cuid())
  instanceId        String
  instance          ProcessInstance     @relation(fields: [instanceId], references: [id])
  taskTemplateId    String
  taskTemplate      ProcessTaskTemplate @relation(fields: [taskTemplateId], references: [id])
  name              String
  stageLabel        String?
  taskType          TaskType
  status            String             @default("NOT_STARTED")
  plannedStartAt    DateTime?
  plannedEndAt      DateTime?
  actualStartAt     DateTime?
  actualEndAt       DateTime?
  deadlineAt        DateTime?
  worklogId         String?
  cooperationId     String?
  approvalRequestId String?
  assigneeId        String?
  decidedById       String?
  decisionReason    String?
  initiativeId      String?
  initiative        Initiative?        @relation(fields: [initiativeId], references: [id])
  createdAt         DateTime           @default(now())
  updatedAt         DateTime           @updatedAt
}

model Holiday {
  id        String   @id @default(cuid())
  date      DateTime @unique
  name      String
  isLegal   Boolean  @default(true)
  createdBy String
  createdAt DateTime @default(now())
}

model Item {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
}

model Mold {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
}

model CarModel {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  createdAt DateTime @default(now())
}
